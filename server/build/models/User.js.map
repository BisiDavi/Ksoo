{"version":3,"sources":["../../src/models/User.js"],"names":["Schema","mongoose","userSchema","provider","type","String","required","username","lowercase","unique","match","index","email","password","trim","minlength","maxlength","name","avatar","role","default","bio","googleId","sparse","facebookId","messages","Types","ObjectId","ref","timestamps","console","log","__dirname","process","env","IMAGES_FOLDER_PATH","methods","toJSON","absoluteAvatarFilePath","fs","existsSync","id","_id","createdAt","updatedAt","isProduction","NODE_ENV","secretOrKey","JWT_SECRET_PROD","JWT_SECRET_DEV","generateJWT","token","jwt","sign","expiresIn","registerUser","newUser","callback","bcrypt","genSalt","err","salt","hash","errh","save","comparePassword","candidatePassword","compare","isMatch","hashPassword","saltRounds","hashedPassword","Promise","resolve","reject","validateUser","user","schema","Joi","any","string","min","max","regex","allow","validate","User","model"],"mappings":"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","sourcesContent":["import fs from 'fs';\r\nimport { join } from 'path';\r\nimport mongoose from 'mongoose';\r\nimport bcrypt from 'bcryptjs';\r\nimport jwt from 'jsonwebtoken';\r\nimport Joi from 'joi';\r\nimport { isValidUrl } from '../utils/utils';\r\n\r\nconst { Schema } = mongoose;\r\n\r\nconst userSchema = new Schema(\r\n  {\r\n    provider: {\r\n      type: String,\r\n      required: true,\r\n    },\r\n    username: {\r\n      type: String,\r\n      lowercase: true,\r\n      unique: true,\r\n      required: [true, \"can't be blank\"],\r\n      match: [/^[a-zA-Z0-9_]+$/, 'is invalid'],\r\n      index: true,\r\n    },\r\n    email: {\r\n      type: String,\r\n      lowercase: true,\r\n      unique: true,\r\n      required: [true, \"can't be blank\"],\r\n      match: [/\\S+@\\S+\\.\\S+/, 'is invalid'],\r\n      index: true,\r\n    },\r\n    password: {\r\n      type: String,\r\n      trim: true,\r\n      minlength: 6,\r\n      maxlength: 60,\r\n    },\r\n    name: String,\r\n    avatar: String,\r\n    role: { type: String, default: 'USER' },\r\n    bio: String,\r\n    // google\r\n    googleId: {\r\n      type: String,\r\n      unique: true,\r\n      sparse: true,\r\n    },\r\n    // fb\r\n    facebookId: {\r\n      type: String,\r\n      unique: true,\r\n      sparse: true,\r\n    },\r\n    messages: [{ type: mongoose.Schema.Types.ObjectId, ref: 'Message' }],\r\n  },\r\n  { timestamps: true },\r\n);\r\n\r\nconsole.log(join(__dirname, '../..', process.env.IMAGES_FOLDER_PATH));\r\n\r\nuserSchema.methods.toJSON = function () {\r\n  // if not exists avatar1 default\r\n  const absoluteAvatarFilePath = `${join(__dirname, '../..', process.env.IMAGES_FOLDER_PATH)}${this.avatar}`;\r\n  const avatar = isValidUrl(this.avatar)\r\n    ? this.avatar\r\n    : fs.existsSync(absoluteAvatarFilePath)\r\n      ? `${process.env.IMAGES_FOLDER_PATH}${this.avatar}`\r\n      : `${process.env.IMAGES_FOLDER_PATH}avatar2.jpg`;\r\n\r\n  return {\r\n    id: this._id,\r\n    provider: this.provider,\r\n    email: this.email,\r\n    username: this.username,\r\n    avatar: avatar,\r\n    name: this.name,\r\n    role: this.role,\r\n    createdAt: this.createdAt,\r\n    updatedAt: this.updatedAt,\r\n  };\r\n};\r\n\r\nconst isProduction = process.env.NODE_ENV === 'production';\r\nconst secretOrKey = isProduction ? process.env.JWT_SECRET_PROD : process.env.JWT_SECRET_DEV;\r\n\r\nuserSchema.methods.generateJWT = function () {\r\n  const token = jwt.sign(\r\n    {\r\n      expiresIn: '12h',\r\n      id: this._id,\r\n      provider: this.provider,\r\n      email: this.email,\r\n    },\r\n    secretOrKey,\r\n  );\r\n  return token;\r\n};\r\n\r\nuserSchema.methods.registerUser = (newUser, callback) => {\r\n  bcrypt.genSalt(10, (err, salt) => {\r\n    bcrypt.hash(newUser.password, salt, (errh, hash) => {\r\n      if (err) {\r\n        console.log(err);\r\n      }\r\n      // set pasword to hash\r\n      newUser.password = hash;\r\n      newUser.save(callback);\r\n    });\r\n  });\r\n};\r\n\r\nuserSchema.methods.comparePassword = function (candidatePassword, callback) {\r\n  bcrypt.compare(candidatePassword, this.password, (err, isMatch) => {\r\n    if (err) return callback(err);\r\n    callback(null, isMatch);\r\n  });\r\n};\r\n\r\n// const delay = (t, ...vs) => new Promise(r => setTimeout(r, t, ...vs)) or util.promisify(setTimeout)\r\n\r\nexport async function hashPassword(password) {\r\n  const saltRounds = 10;\r\n\r\n  const hashedPassword = await new Promise((resolve, reject) => {\r\n    bcrypt.hash(password, saltRounds, function (err, hash) {\r\n      if (err) reject(err);\r\n      else resolve(hash);\r\n    });\r\n  });\r\n\r\n  return hashedPassword;\r\n}\r\n\r\nexport const validateUser = (user) => {\r\n  const schema = {\r\n    avatar: Joi.any(),\r\n    name: Joi.string().min(2).max(30).required(),\r\n    username: Joi.string()\r\n      .min(2)\r\n      .max(20)\r\n      .regex(/^[a-zA-Z0-9_]+$/)\r\n      .required(),\r\n    password: Joi.string().min(6).max(20).allow('').allow(null),\r\n  };\r\n\r\n  return Joi.validate(user, schema);\r\n};\r\n\r\nconst User = mongoose.model('User', userSchema);\r\n\r\nexport default User;\r\n"],"file":"User.js"}